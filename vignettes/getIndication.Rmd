---
title: "GetIndication"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{GetIndication}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(DrugUtilisation)
```

## Introduction
The getIndication() function will get indication for a target cohort. It must contain the targetCohortName and indicationCohortName table in it. The function will then identify a single/multiple cohort ids, single/multiple indications, and single/multiple gaps.

## Data simulation
Let's start with simulating data in the cdm format for the target cohort and indication cohort. We will also specify the set of indications of interest.

```{r eval=TRUE}
  targetCohortName <- dplyr::tibble(
    cohort_definition_id = c(1, 1, 1, 2),
    subject_id = c(1, 1, 2, 3),
    cohort_start_date = as.Date(c(
      "2020-01-01", "2020-06-01", "2020-01-02", "2020-01-01"
    )),
    cohort_end_date = as.Date(c(
      "2020-04-01", "2020-08-01", "2020-02-02", "2020-03-01"
    ))
  ) # this is the targetCohort
  indicationCohortName <- dplyr::tibble(
    cohort_definition_id = c(1, 1, 2, 3, 1),
    subject_id = c(1, 3, 1, 2, 1),
    cohort_start_date = as.Date(
      c(
        "2019-12-30",
        "2020-01-01",
        "2020-05-25",
        "2020-01-01",
        "2020-05-25"
      )
    ),
    cohort_end_date = as.Date(
      c(
        "2019-12-30",
        "2020-01-01",
        "2020-05-25",
        "2020-01-01",
        "2020-05-25"
      )
    )
  )
  condition_occurrence <- dplyr::tibble(
    person_id = 1,
    condition_start_date = as.Date("2020-05-31")
  )
  
  indicationDefinitionSet <- dplyr::tibble(
    cohortId = c(1, 2),
    cohortName = c("asthma", "covid")
  )
  
  cdm <-
    mockDrugUtilisation(
      cohort1 = targetCohortName,
      cohort2 = indicationCohortName,
      condition_occurrence = condition_occurrence
    )
cdm$cohort1
cdm$cohort2
```

## Use getIndication() for indications with different gap values 
Gap value is the number of days between indication start day and target cohort start day

* 0 gap days: Indication start day is the same day as target cohort start day

* 2 gap days: Indication start day is within two days (before or after) of the target cohort day

* Not specified (NA): Indication start day is at any time (before or after) around  the target cohort day

* A combination of different gap days

```{r eval=TRUE}
  res_0 <- suppressWarnings(getIndication(
    cdm = cdm,
    targetCohortName = "cohort1",
    indicationCohortName = "cohort2",
    targetCohortDefinitionIds = 1,
    indicationDefinitionSet = indicationDefinitionSet,
    indicationGap = 0,
    unknownIndicationTables = NULL
  ))

res_0

  res_2 <- suppressWarnings(getIndication(
    cdm = cdm,
    targetCohortName = "cohort1",
    indicationCohortName = "cohort2",
    targetCohortDefinitionIds = 1,
    indicationDefinitionSet = indicationDefinitionSet,
    indicationGap = 2,
    unknownIndicationTables = NULL
  ))

res_2

  res_na <- suppressWarnings(getIndication(
    cdm = cdm,
    targetCohortName = "cohort1",
    indicationCohortName = "cohort2",
    targetCohortDefinitionIds = 1,
    indicationDefinitionSet = indicationDefinitionSet,
    indicationGap = 2,
    unknownIndicationTables = NULL
  ))

res_na

  res_3 <- suppressWarnings(getIndication(
    cdm = cdm,
    targetCohortName = "cohort1",
    indicationCohortName = "cohort2",
    targetCohortDefinitionIds = 1,
    indicationDefinitionSet = indicationDefinitionSet,
    indicationGap = c(0,1,7),
    unknownIndicationTables = NULL
  ))

res_3

```

## Use getIndication() with an unknow indication table

This option finds all the events occurring in the specified table that fall within the specified gap. We chose the "condition_occurrence" table. There was one observation in "condition_occurrence" that started within one day of the target cohort start day for one patient.

```{r eval=TRUE}
  res_1 <- suppressWarnings(getIndication(
    cdm = cdm,
    targetCohortName = "cohort1",
    indicationCohortName = "cohort2",
    targetCohortDefinitionIds = 1,
    indicationDefinitionSet = indicationDefinitionSet,
    indicationGap = 1,
    unknownIndicationTables = "condition_occurrence"
  ))

res_1

```

## Use getIndication() with multiple target cohort definition IDs

This option allows for including more than one target cohort ID. For example, in the target cohort, we have two cohort_definition_id values. We only allowed for one value (1) in the above examples. In the example below, we choose a combination of more than one cohort_definition_id, i.e., more than one target cohort.

```{r eval=TRUE}

res_m <- suppressWarnings(getIndication(
  cdm = cdm,
  targetCohortName = "cohort1",
  indicationCohortName = "cohort2",
  targetCohortDefinitionIds = c(1,2),
  indicationDefinitionSet = indicationDefinitionSet,
  indicationGap = 0,
  unknownIndicationTables = NULL
))

res_m

```

## Summarise indication tables

This function allows for summarising the indication tables we created above. There are a few options to specify for this function as well:

* Specifying different minimum cell count: If the count in a specific field is below a certain cut-off (1 or 3 in the examples below), then the summary will just show that it is below the cut-off without giving more details

* Specifying one or multiple target cohorts: When more than one target cohort_definition_id exist in an indication table, this option allows to subset the summary table to only the target cohort_definition_id of interest

```{r eval=TRUE}

result_3_1 <- summariseIndication(cdm = cdm, indicationList = res_3, minimumCellCounts = 1)
result_3_3 <- summariseIndication(cdm = cdm, indicationList = res_3, minimumCellCounts = 3)

result_m_all <- summariseIndication(cdm = cdm, indicationList = res_m, minimumCellCounts = 1)
result_m_1 <- summariseIndication(cdm = cdm, indicationList = res_m, minimumCellCounts = 1,cohortId = 1)

result_3_1
result_3_3
result_m_all
result_m_1
```

